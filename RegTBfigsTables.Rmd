```{r setup, echo=FALSE, include=FALSE}
###################################################
# Tom Hiatt
# Updated: 12 March 2014
# Regional TB annual analysis
###################################################

# > sessionInfo()
# R version 3.0.2 (2013-09-25)
# Platform: i386-w64-mingw32/i386 (32-bit)
# 
# locale:
# [1] LC_COLLATE=English_United Kingdom.1252 
# [2] LC_CTYPE=English_United Kingdom.1252   
# [3] LC_MONETARY=English_United Kingdom.1252
# [4] LC_NUMERIC=C                           
# [5] LC_TIME=English_United Kingdom.1252    
# 
# attached base packages:
# [1] grid      stats     graphics  grDevices utils     datasets  methods  
# [8] base     
# 
# other attached packages:
#  [1] maptools_0.8-27    sp_1.0-14          knitr_1.5         
#  [4] ggthemes_1.6.0     timeSeries_3010.97 timeDate_3010.98  
#  [7] stringr_0.6.2      xtable_1.7-1       scales_0.2.3      
# [10] ggplot2_0.9.3.1    reshape_0.8.4      plyr_1.8          
# 
# loaded via a namespace (and not attached):
#  [1] colorspace_1.2-4   dichromat_2.0-0    digest_0.6.4      
#  [4] evaluate_0.5.1     foreign_0.8-55     formatR_0.10      
#  [7] gtable_0.1.2       labeling_0.2       lattice_0.20-23   
# [10] MASS_7.3-29        munsell_0.4.2      proto_0.3-10      
# [13] RColorBrewer_1.0-5 reshape2_1.2.2     tools_3.0.2 

require("reshape")
require("ggplot2")
require("grid")
require("scales")
require("xtable")
require("stringr")
require("timeSeries")
require("ggthemes")


# Reproducible research process inspired by: http://gforge.se/2014/01/fast-track-publishing-using-knitr-part-ii/

# Global options for knitr
# change this to 'postscript' for EPS output.
require(knitr)
opts_chunk$set(
#   dev="png",
#   dev.args=list(type="cairo"),
#   dpi=96,
  fig.width=7,
  echo=FALSE
  )

whbc <- c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM")

# Create regional report folder if needed.
# dir.create("./Regional_report") # run this if error below
if(!any(grep("Regional_report", getwd()))) setwd("./Regional_report")


# Theme for plots
theme_report <- function(base_size=12, base_family="") {
    colors <- ggthemes_data$few
    gray <- colors$medium['gray']
    black <- colors$dark['black'] # I don't know why these last 3 parts are needed, but they are. List is here: http://docs.ggplot2.org/0.9.2.1/theme.html
    theme_bw(base_size=base_size, base_family=base_family) +
        theme(
            line = element_line(colour = gray),
            rect = element_rect(fill = "white", colour = NA),
            text = element_text(colour = black),
            axis.ticks.x = element_line(colour = gray),
            axis.ticks.y = element_blank(),
            legend.key = element_rect(colour = NA),
            ## Examples do not use grid lines
            panel.border = element_rect(colour = gray),
            panel.grid.major.x = element_blank(),
            panel.grid.minor = element_blank(),
            strip.background = element_rect(fill="white", colour=NA),
            strip.text = element_text(hjust=0)
            )
}

########################################################
# Functions for data formatting
########################################################

# Simple rounder that just adds in the thousands separator 
rounder <- function(x, decimals=FALSE) {
  if(decimals==TRUE){
    ifelse(is.na(x), NA, ifelse(x==0, 0, ifelse(x < 0.01, "<0.01", ifelse(round(x,2) < 0.1, formatC(round(x,2), format='f', digits=2), ifelse(round(x,1) < 10, formatC(round(x,1), format='f', digits=1), formatC(round(x,0), big.mark=" ", format='d') )))))
  }
  else ifelse(is.na(x), NA, ifelse(x==0, 0, ifelse(x < 1, "< 1", formatC(round(x,0), big.mark=" ", format='d'))))
}

.rowsums <- function(x) { 
  # This function sums rows ignoring NAs unless all are NA
  # use it like this
  # t3c$snu <- .rowsums(t3c[c('new_sn', 'new_su')])
		tosum <- as.matrix(x)
		summed <- rowMeans((tosum), na.rm=T) * rowSums(!is.na((tosum)))
		return(summed)
}

# Change names to WPSAR convention
.WPSARnames <- function(d, col='country', ord='no order'){
  d[col] <- as.character(d[[col]])
  d[col] <- ifelse(d[[col]]=='China, Hong Kong SAR', 'Hong Kong Special Administrative Region (China)', 
                   ifelse(d[[col]]=='China, Macao SAR', 'Macao Special Administrative Region (China)', 
                          ifelse(d[[col]]=='Micronesia (Federated States of)', 'Micronesia, Federated States of', 
                                 ifelse(d[[col]]=='WPR', 'Western Pacific Region
', d[[col]]))))

  if(!ord %in% c('wpr')) warning('Not ordering.')
if(ord=='wpr')  d <- d[match(c("Afghanistan", "Bangladesh", "Brazil", "Cambodia", "China", "DR Congo", "Ethiopia", "India", "Indonesia", "Kenya", "Mozambique",  "Myanmar", "Nigeria", "Pakistan", "Philippines", "Russian Federation", "South Africa", "Thailand", "Uganda", "UR Tanzania", "Viet Nam", "Zimbabwe", "High-burden countries", "AFR", "AMR", "EMR", "EUR", "SEAR", "WPR", "Global"), d[[col]]),]

  return(d)
}

########################################################
# Functions for maps
########################################################

source("./MapFunctions.r")
load("gparts.Rdata")

########################################################
# Functions to assist with tables and figure in markdown document (from here: http://rmflight.github.io/posts/2012/10/papersinRmd.html)
########################################################

yr <- as.numeric(format(Sys.time(),"%Y")) - ifelse(as.numeric(format(Sys.time(),"%m")) < 4, 2, 1)

incCount <- function(inObj, useName) {
  nObj <- length(inObj)
  useNum <- max(inObj) + 1
  inObj <- c(inObj, useNum)
  names(inObj)[nObj + 1] <- useName
  inObj
}
figCount <- c(`_` = 0)
tableCount <- c(`_` = 0)

# tableCount

pasteLabel <- function(preText, inObj, objName, insLink = TRUE) {
  objNum <- inObj[objName]
  
  useText <- paste(preText, objNum, sep = " ")
  if (insLink) {
    useText <- paste("[", useText, "](#", objName, ")", sep = "")
  }
  useText
}

tableCat <- function(inFrame) {
  outText <- paste(names(inFrame), collapse = " | ")
  outText <- c(outText, paste(rep("---", ncol(inFrame)), collapse = " | "))
  invisible(apply(inFrame, 1, function(inRow) {
    outText <<- c(outText, paste(inRow, collapse = " | "))
  }))
  return(outText)
}

# Create directory and Get data

if(!"data" %in% dir()){
  dir.create(paste("./data"))
  stop("Download the notification and treatment outcomes data from 'http://who.int/tb/country/data/download/en/' to './data'.")
  }

data1 <- dir("./data", full.names=TRUE)
tb <- NA
for(i in data1){
  data3 <- read.csv(i)
  tb <- merge(tb, data3, all=TRUE)
}

# Add needed variables
tb$g_hbc22 <- ifelse(tb$iso3 %in% c("AFG", "BGD", "BRA", "CHN", "COD", "ETH", "IDN", "IND", "KEN", "KHM", "MMR", "MOZ", "NGA", "PAK", "PHL", "RUS", "THA", "TZA", "UGA", "VNM", "ZAF", "ZWE"), "high", "low")

tb$c_new <- .rowsums(tb[c("new_sp", "new_sn", "new_su", "new_ep", "new_oth")])
tb$c_newinc <- .rowsums(tb[c("c_new", "ret_rel", "newret_oth")])
tb$c_ret <- .rowsums(tb[c("ret_rel", "ret_taf", "ret_tad", "ret_oth")])
tb$c_notified <- .rowsums(tb[c("c_new", "c_ret", "newret_oth")])

tb$c_tot_newrel_100k <- tb$tot_newrel / tb$e_pop_num * 1e5

# Get population data (available from UN population division. http://esa.un.org/unpd/wpp/unpp/panel_population.htm) and formatted TB/HIV data and estimates for the WHO Western Pacific Region.

load("./addata.Rdata")

tb <- merge(tb, tbhiv[c(3,4,13:20)], all=TRUE)

```


Epidemiology and control of tuberculosis in the Western Pacific Region: analysis of case notification data in 2012
========================================================

Abstract 
--------------------------------------------------------

### Background

### Methods

### Results

### Conclusion


Introduction
--------------------------------------------------------

The Western Pacific Region has seen significant gains in the fight against tuberculosis (TB) in the last decade with estimated incidence rates 

Methods
--------------------------------------------------------

Data were collected through an on-line data collection system.


Results
--------------------------------------------------------


### Case notification

```{r t-notif-data, warning=FALSE}
tableCount <- incCount(tableCount, "t-notif")

# Notification table

tbb <- subset(tb, year==yr & g_whoregion=="WPR", select=c('country', 'g_whoregion', 'c_notified', "new_sp", "new_sn", "new_su", "new_ep", "new_oth", "ret_rel", 'c_newinc', "c_ret", "newret_oth", "new_labconf", 'c_new', "e_pop_num"))

tbb$new.pulm <- .rowsums(tbb[c('new_sp', 'new_sn', 'new_su')])

tbb <- tbb[order(tbb$country),]
names(tbb)[names(tbb)=='country'] <- 'area'

# make aggregate row
tbbr <- aggregate(tbb[3:ncol(tbb)], by=list(area=tbb$g_whoregion), FUN=sum, na.rm=TRUE)


# combine together
tbc <- rbind(tbb[tbb$g_whoregion=='WPR', c(1, 3:ncol(tbb))], tbbr[tbbr$area=='WPR',]) # , tbbh, tbbga

# Fill in data for countries not reporting lab confirmed (see below too)
tbc$new_labconf2 <- ifelse(is.na(tbc$new_labconf), tbc$new_sp, tbc$new_labconf)

# calculate and format vars
tbc$ret_nrel <- tbc$c_ret - tbc$ret_rel
tbc$newpulm_lab_pct <- tbc$new_labconf2 / tbc$new.pulm * 100
tbc$tot_newrel_100k <- tbc$c_newinc / tbc$e_pop_num * 1e5

for(var in 2:ncol(tbc)){
  tbc[var] <- rounder(tbc[[var]])
}
tbc[is.na(tbc$newpulm_lab_pct), 'newpulm_lab_pct'] <-  "--"
tbc[is.na(tbc$tot_newrel_100k), 'newpulm_lab_pct'] <-  "--"

# Add footnote for countries not reporting Lab confirmed 
footnote.b <- ifelse(any(is.na(tbc$new_labconf) & !is.na(tbc$new_sp)), paste('(b) LABORATORY CONFIRMED data for', paste(subset(tbc, is.na(new_labconf), 'area'), collapse=', '), 'refer to smear-positive cases only. Data on cases that were laboratory confirmed using other methods were not reported.'), "")
tbc$new_labconf2 <- ifelse(is.na(tbc$new_labconf) & !is.na(tbc$new_sp), paste0(tbc$new_sp, "(b)"), tbc$new_labconf2)

# Rename countries
tbd <- .WPSARnames(tbc[c("area", "c_notified", "tot_newrel_100k", "new_sp", "new_sn", "new_su", "new_ep", "new_oth", "new_labconf2", "newpulm_lab_pct", "ret_rel", "ret_nrel", "c_newinc")], col="area")

tbm <- xtable(tbd)
digits(tbm) <- 0

write.csv(tbm, file=paste0(pasteLabel("./figure data/table", tableCount, "t-notif", insLink=FALSE), ".csv"), row.names=FALSE, na="")
```

```{r m-notif-data, include=FALSE}

figCount <- incCount(figCount, "m-notif")

mc <- subset(tb, year==yr & g_whoregion=="WPR", select=c(country, iso2, iso3, g_whoregion, c_tot_newrel_100k))

mc$cat <- cut(round(mc$c_tot_newrel_100k,0), c(0, 10, 50, 100, 200, Inf), c('0–9', '10–49', '50–99', '100–199', '>199'), right=FALSE)

mc1 <- WHOmap.print(mc, legend.title= "TB cases per \n100 000 population", copyright=FALSE, show=FALSE, zoom="WPR")

write.csv(mc, file=paste0(pasteLabel("./figure data/figure", figCount, "m-notif", insLink=FALSE), ".csv"), row.names=FALSE)
```

In `r yr`, national TB control programmes (NTPs) reported `r cnotw <- sum(tb[tb$year==yr & tb$g_whoregion=="WPR", "c_notified"], na.rm=TRUE) ; round(cnotw / 1e6, 1)` million people with TB in the region (`r I(pasteLabel("Table", tableCount, "t-notif"))`) making up `r round(cnotw / sum(tb[tb$year==yr, "c_notified"], na.rm=TRUE) * 100, 0)`% of the global burden. Of these cases `r nrw <- sum(tb[tb$year==yr & tb$g_whoregion=="WPR", "tot_newrel"], na.rm=TRUE) ; round(nrw / cnotw * 100, 0)`% were new episodes of TB (either new or relapse cases). Within the region China accounts for `r round(sum(tb[tb$year==yr & tb$iso2=="CN", "tot_newrel"], na.rm=TRUE) / nrw * 100, 0)`% of the caseload with the Philippines and Viet Nam following with `r round(sum(tb[tb$year==yr & tb$iso2=="PH", "tot_newrel"], na.rm=TRUE) / nrw * 100, 0)`% and `r round(sum(tb[tb$year==yr & tb$iso2=="VN", "tot_newrel"], na.rm=TRUE) / nrw * 100, 0)`% respectively. TB notification rates vary substantially in the region with the highest rates found in `r hnr <- .maxplus(tb[tb$year==yr & tb$g_whoregion=="WPR", c("country", "c_tot_newrel_100k")], 'c_tot_newrel_100k', 4) ; paste(paste(hnr[1:3,1], collapse=", "), "and", hnr[4,1])` (`r I(pasteLabel("Figure", figCount, "m-notif"))`). 

<a id="t-notif"></a> 
#### `r I(pasteLabel("Table", tableCount, "t-notif", insLink=FALSE))`. Case notifications, `r yr`.
```{r t-notif, results='asis'}

print(tbm, type="html", include.rownames=FALSE, include.colnames=F, html.table.attributes="border=0 rules=rows width=900 cellpadding=5", 
      add.to.row=list(pos=list(0,37), command=c(
"<TR> <TD colspan=3></TD> 
  <TH colspan=7>NEW CASES</TH> 
  <TH colspan=2>RETREATMENT CASES</TH> 
  <TD colspan=1></TD> </TR> 
  <TR> <TD></TD> <TD>TOTAL NOTIFIED</TD>
  <TD>TOTAL NOTIFIED PER 100 000</TD>
  <TD>SMEAR-<br>POSITIVE</TD> 
  <TD>SMEAR-<br>NEGATIVE</TD> 
  <TD>SMEAR NOT DONE</TD>
  <TD>EXTRA-<br>PULMONARY</TD> 
  <TD>CASE TYPE<br> UNKNOWN</TD> 
  <TD>PULMONARY CASES LABORATORY CONFIRMED</TD> 
  <TD>PERCENTAGE OF PULMONARY CASES LABORATORY CONFIRMED</TD>   
  <TD>RELAPSE</TD> 
  <TD>RETREATMENT<br>EXCL. RELAPSE</TD> 
  <TD>NEW AND<br>RELAPSE(a)</TD> 
 </TR>", 
  paste0("<TR> <TD colspan=13>Blank cells indicate data not reported. -- indicates values that cannot be calculated.<br>
(a) NEW AND RELAPSE includes cases for which the treatment history is unknown.<br>Data reported as of 1 October 2013. See ANNEX 4 of Global Tuberculosis Report, 2013.<br>", footnote.b,"</TD></TR>"))))

```



<a id="m-notif"></a> 
#### `r I(pasteLabel("Figure", figCount, "m-notif", insLink=FALSE))` New and relapse rates per 100 000 population in countries and areas of the Western Pacific Region, `r yr`.
```{r m-notif, fig.height=5}

mc1
```


```{r f-notif-trend-data}

figCount <- incCount(figCount, "f-notif-trend")

nota <- subset(tb, year >= 2000 & g_whoregion=="WPR", c(year, tot_newrel, new_sp, e_pop_num))

notb <- aggregate(nota[2:ncol(nota)], by=list(year=nota$year), FUN=sum, na.rm=TRUE)

notb$`All forms of TB` <- notb$tot_newrel / notb$e_pop_num * 1e5
notb$`New smear-positive` <- notb$new_sp / notb$e_pop_num * 1e5
notc <- melt(notb[c("year", "New smear-positive", "All forms of TB")], id=1)

write.csv(notc, file=paste0(pasteLabel("./figure data/figure", figCount, "f-notif-trend", insLink=FALSE), ".csv"), row.names=FALSE)
```


<a id="f-notif-trend"></a> 
#### `r I(pasteLabel("Figure", figCount, "f-notif-trend", insLink=FALSE))` Case notification rates per 100 000 population in countries and areas of the Western Pacific Region, 2000--`r yr`.
```{r f-notif-trend, fig.height=5}

ggplot(notc, aes(year, value, color=variable, ymin=0)) + geom_line(size=1) + theme_report() + scale_x_continuous("", breaks = pretty_breaks()) + scale_y_continuous("TB cases per 100 000", breaks = pretty_breaks()) + theme(legend.position="none") + geom_text(data=subset(notc, year==max(notc$year)), aes(label=variable), hjust=1.1, vjust=3) + scale_color_brewer(type="qual", palette=6)

```

## Age and sex

```{r agesex-data,  echo=FALSE}
figCount <- incCount(figCount, "f-agesex-bar")
figCount <- incCount(figCount, "f-agesex")

aga <- merge(subset(tb, year>1999, select=c("iso3", "country", "year", "g_whoregion", "g_hbc22", "new_sp_m04", "new_sp_m514", "new_sp_m014", "new_sp_m1524", "new_sp_m2534", "new_sp_m3544", "new_sp_m4554", "new_sp_m5564", "new_sp_m65", "new_sp_mu", "new_sp_f04", "new_sp_f514", "new_sp_f014", "new_sp_f1524",  "new_sp_f2534", "new_sp_f3544", "new_sp_f4554", "new_sp_f5564", "new_sp_f65", "new_sp_fu")), subset(p, year>1999, select=c("iso3", "country", "year", "e_pop_m04", "e_pop_m514", "e_pop_m014", "e_pop_m1524", "e_pop_m2534", "e_pop_m3544", "e_pop_m4554", "e_pop_m5564", "e_pop_m65", "e_pop_f04", "e_pop_f514", "e_pop_f014", "e_pop_f1524", "e_pop_f2534", "e_pop_f3544", "e_pop_f4554", "e_pop_f5564", "e_pop_f65")))

# Aggregate for region
agb1 <- aggregate(aga[6:ncol(aga)], by=list(year=aga$year, area=aga$g_whoregion), FUN=sum, na.rm=TRUE)

agb1[c('iso3', 'g_hbc22')] <- NA
agb1$g_whoregion <- agb1$area
aga1 <- rename(aga,c('country'='area'))
agb <- rbind(aga1, agb1)

# Calculate rates

agc <- melt(agb, id=1:5)
# agc[c('new', 'type', 'group')] <- str_split_fixed(agc$variable, '_', n=3) # This takes me 25 seconds...it's the '_all' or '_fixed' that's the killer.
agc$type <- str_extract(agc$variable, 'new_sp|pop')
agc$age <- str_replace(agc$variable, "new_sp_|e_pop_", "")
agc$sex <- str_replace(agc$age, '[u]|[0-9]+', "")
agc$age <- str_replace(agc$age, '[f]|[m]', "")

agd <- cast(subset(agc, select= -variable), ...~type)

agd$new_sp_100k <- agd$new_sp / agd$pop * 1e5

# Subset for WPRO
age <- subset(agd, (iso3 %in% whbc | area=="WPR") & age!="u" & !age %in% c("04", "514"))
age$sex <- factor(age$sex, levels=c("m", "f"), labels=c("Male", "Female"))
age$sh.name <- factor(age$iso3, c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM", "WPR"), c("Cambodia", "China", "Lao People’s \nDemocratic Republic", "Mongolia", "Papua New Guinea", "Philippines", "Viet Nam", "WPR"))
age[is.na(age$sh.name), 'sh.name'] <- "WPR"
age$age <- factor(age$age, c("014", "1524", "2534", "3544", "4554", "5564", "65"), c("0–14", "15–24", "25–34", "35–44", "45–54", "55–64", "\u2265 65"))

write.csv(age, file=paste0(pasteLabel("./figure data/figure", figCount, "f-agesex-bar", insLink=FALSE), ".csv"), row.names=FALSE)

write.csv(age, file=paste0(pasteLabel("./figure data/figure", figCount, "f-agesex", insLink=FALSE), ".csv"), row.names=FALSE)
```

The age distribution in `r yr` follows an increasing pattern characteristic of an aging epidemic for all high-burden countries except Mongolia and Papua New Guinea (`r I(pasteLabel("Figure", figCount, "f-agesex-bar"))`). Rates among females is less similar with rates in the `r "\u2265 65"` category lower than their younger counter-parts in many settings.

<a id="f-agesex-bar"></a> 
#### `r I(pasteLabel("Figure", figCount, "f-agesex-bar", insLink=FALSE))` Smear-positive notification rates by age and sex in the Region and in seven countries with a high burden of TB, `r yr`.
``` {r f-agesex-bar, fig.height=11, warning=FALSE}

p2 <- ggplot(subset(age, year==yr), aes(age, new_sp_100k, fill=sex)) + geom_bar(stat="identity", position="dodge") + facet_wrap(~sh.name, scales='free_y', ncol=2)   + theme_report() + scale_fill_brewer('Sex', type="qual", palette=6) + scale_x_discrete("Age group", labels=c("0–14", "15–24", "25–34", "35–44", "45–54", "55–64", "\u2265 65")) + theme(legend.position="bottom")

p2 + scale_y_continuous("New smear-positive cases per 100 000")


```

<a id="f-agesex"></a> 
#### `r I(pasteLabel("Figure", figCount, "f-agesex", insLink=FALSE))` Trends of notification rates of new smear-positive TB cases in specific age and sex groups, `r yr`.
``` {r f-agesex, warning=FALSE, fig.height=15}

p1 <- ggplot(age, aes(year, new_sp_100k, color=age)) + geom_line() + facet_grid(sh.name~sex, scales='free_y') + theme_report() + scale_x_continuous("", breaks = pretty_breaks()) + scale_color_brewer("Age group", type="seq", palette=4)

p1 + scale_y_continuous("New smear-positive cases per 100 000")
# p1 + scale_y_log10("New smear-positive cases per 100 000")                                                                                                                                                        
                                                                                                                                                      #function (x) floor(x)); function(n) n[floor(length(n)/5)*1:5+1]
```

As seen in `r I(pasteLabel("Figure", figCount, "f-agesex"))` the trend is evident.



## Treatment outcomes

```{r f-txout-bar-data}

figCount <- incCount(figCount, "f-txout-bar")

tra <- subset(tb, year %in% 2000:(yr-1), select=c(year, new_sp_coh, new_sp_cur, new_sp_cmplt, new_sp_died, new_sp_fail, new_sp_def))

trb <- aggregate(tra[2:ncol(tra)], by=list(year=tra$year), FUN=sum, na.rm=TRUE)

trb$Success <- (trb$new_sp_cur + trb$new_sp_cmplt) / trb$new_sp_coh * 100
trb$Died <- trb$new_sp_died / trb$new_sp_coh * 100
trb$Failed <- trb$new_sp_fail / trb$new_sp_coh * 100
trb$Defaulted <- trb$new_sp_def / trb$new_sp_coh * 100
trb$`Not evaluated` <- (trb$new_sp_coh - (trb$new_sp_cur + trb$new_sp_cmplt + trb$new_sp_died + trb$new_sp_fail + trb$new_sp_def)) / trb$new_sp_coh * 100

trc <- melt(trb[c("year", "Success", "Died", "Failed", "Defaulted", "Not evaluated")], id=1)

write.csv(trc, file=paste0(pasteLabel("./figure data/figure", figCount, "f-txout-bar", insLink=FALSE), ".csv"), row.names=FALSE)
```


<a id="f-txout-bar"></a> 
#### `r I(pasteLabel("Figure", figCount, "f-txout-bar", insLink=FALSE))` Treatment outcomes for new smear-positive cases in the Region, 2000--`r yr-1`.
``` {r f-txout-bar, fig.width=9}

ggplot(trc, aes(year, value, fill=variable)) + geom_bar(stat="identity", position="stack") + theme_report() + scale_fill_brewer('Outcome', type="qual", palette=6) + scale_x_continuous("", breaks=min(trc$year):max(trc$year)) + scale_y_continuous("Percent of cohort") + coord_cartesian(ylim=c(60,100)) + guides(fill = guide_legend(reverse = TRUE))



```

## TB/HIV

```{r f-tbhiv-data}

figCount <- incCount(figCount, "f-tbhiv")

tha1 <- subset(tb, year >= 2005 & g_whoregion=="WPR" & iso3 %in% whbc, select=c("country", "year", "iso3", "g_hbc22", "c_notified", "hivtest", "hivtest_pos", "hiv_cpt", "hiv_art", "hivtest_pct_numerator", "hivtest_pct_denominator", "hivtest_pos_pct_numerator", "hivtest_pos_pct_denominator", "hiv_cpt_pct_numerator", "hiv_cpt_pct_denominator", "hiv_art_pct_numerator", "hiv_art_pct_denominator"))

tha2 <- aggregate(tha1[5:ncol(tha1)], by=list(year=tha1$year), FUN=sum, na.rm=TRUE)
tha2[c("country", "iso3")] <- "WPR"
tha2[c("g_hbc22")] <- NA
tha <- rbind(tha1, tha2)

tha$test <- tha$hivtest_pct_numerator / tha$hivtest_pct_denominator * 100
tha$pos <- tha$hivtest_pos_pct_numerator / tha$hivtest_pos_pct_denominator * 100
tha$cpt <- tha$hiv_cpt_pct_numerator / tha$hiv_cpt_pct_denominator * 100
tha$art <- tha$hiv_art_pct_numerator / tha$hiv_art_pct_denominator * 100

thb <- melt(tha[c("iso3", "year", "test", "pos", "cpt", "art")], id=1:2)

thb$variable <- factor(thb$variable, levels=c("test", "pos", "cpt", "art"), labels=c("HIV testing \namong TB patients", "HIV-positive among \nTB patients tested", "CPT coverage \namong co-infected", "ART coverage \namong co-infected"))

thb$country <- factor(thb$iso3, c("KHM", "CHN", "LAO", "MNG", "PNG", "PHL", "VNM", "WPR"), c("Cambodia", "China", "Lao \nPeople’s \nDemocratic \nRepublic", "Mongolia", "Papua \nNew \nGuinea", "Philippines", "Viet Nam", "Western \nPacific \nRegion"))

write.csv(thb, file=paste0(pasteLabel("./figure data/figure", figCount, "f-tbhiv", insLink=FALSE), ".csv"), row.names=FALSE)
```


<a id="f-tbhiv"></a> 
#### `r I(pasteLabel("Figure", figCount, "f-tbhiv", insLink=FALSE))` Progress in TB/HIV activities in seven countries in the Region with a high burden of TB, 2005--`r yr`.
``` {r f-tbhiv, fig.width=7, warning=FALSE}

ggplot(thb, aes(year, value)) + geom_line(size=1) + facet_grid(country~variable) + theme_report() + labs(y="Percent", x="")

```



Discussion
--------------------------------------------------------

```{r f-est-data}

figCount <- incCount(figCount, "f-est")

eget <- c("year", "e_pop_num", "e_inc_100k", "e_inc_100k_lo", "e_inc_100k_hi", "e_prev_100k", "e_prev_100k_lo", "e_prev_100k_hi", "e_mort_exc_tbhiv_100k", "e_mort_exc_tbhiv_100k_lo", "e_mort_exc_tbhiv_100k_hi")

# esta <- subset(estimates, year >=1990 & group_name=="WPR", select=eget)
estb <- tb[tb$year>=1990 & tb$g_whoregion=="WPR", c("year", "tot_newrel")]
estc <- aggregate(estb["tot_newrel"], by=list(year=estb$year), FUN=sum, na.rm=TRUE)

estd <- merge(esta, estc)

estd$c_tot_newrel_100k <- estd$tot_newrel / estd$e_pop_num * 1e5

estf <- NULL
for(var in c("inc", "prev", "mort_exc_tbhiv")){
  df <- subset(estd, select=c("year", paste0("e_", var, "_100k"), paste0("e_", var, "_100k_lo"), paste0("e_", var, "_100k_hi")))
  names(df) <- c("year", "best", "lo", "hi")
  df$var <- var
  estf <- rbind(estf, df)
}

estg <- estd[c("year", "c_tot_newrel_100k")]
estg$var <- "inc"

esth <- merge(estf, estg, all.x=TRUE)
esth$var <- factor(esth$var, levels=c("inc", "prev", "mort_exc_tbhiv"), labels=c("Incidence and notification", "Prevalence", "Mortality (excluding HIV)"))

write.csv(esth, file=paste0(pasteLabel("./figure data/figure", figCount, "f-est", insLink=FALSE), ".csv"), row.names=FALSE)
```


<a id="f-est"></a> 
#### `r I(pasteLabel("Figure", figCount, "f-est", insLink=FALSE))` Tuberculosis case notification rate per 100 000 population, estimated incidence, prevalence and mortality in the Western Pacific Region, 1990--`r yr-1`.
``` {r f-est, fig.height=3.5}

ggplot(esth, aes(year, best, fill=var, ymin=0)) + geom_line(size=1, aes(color=var)) + geom_ribbon(aes (year, best, ymin=lo, ymax=hi), alpha=0.2) + geom_line(aes(year, c_tot_newrel_100k), color="black", size=1) + theme_report() + facet_wrap(~var, scales="free_y") + theme(legend.position="none") + scale_x_continuous("", minor_breaks=seq(1990, yr, 1)) + scale_y_continuous(breaks=pretty_breaks()) + ylab("Rate per 100 000 population")

#breaks=c(seq(1990, 2010, 5), yr), labels=c(seq(1990, 2005, 5),"", yr)
```



Annex
--------------------------------------------------------

The annex will go here.




